### 이상현상

이상현상(anomaly) : 테이블에 투플을 삽입할 때 부득이하게 NULL 값이 입력되거나, 삭제 시 연쇄삭제 현상이 발생하거나, 수정 시 데이터의 일관성이 훼손되는 현상


삭제이상 : 투플 삭제 시 같이 저장된 다른 정보까지 연쇄적으로 삭제되는 현상
-> 연쇄삭제 문제 발생


삽입이상 : 투플 삽입 시 특정 속성에 해당하는 값이 없어 NULL 값을 입력해야 하는 현상
-> NULL값 문제 발생


수정이상 : 투플 수정 시 중복으로 저장된 데이터 일부만 수정되어 데이터의 불일치 문제가 일어나는 현상
-> 일관성(Inconsistency) 없음 문제 발생


### 함수 종속성

어떤 속성 A의 값을 알면 다른 속성 B의 값이 유일하게 정해지는 의존 관계
- 속성 B는 속성 A에 종속한다
- 속성 A는 속성 B를 결정한다
- A -> B
- A는 B의 결정자


함수 종속성을 판단할 때는 릴레이션(테이블)의 현재 인스턴스(데이터)만을 가지고 판단하는 것이 아니라, 속성(열)이 갖는 의미를 가지고 판단해야 한다.


왼쪽 속성의 모든 값에 대하여 오른쪽 속성의 값이 유일하게 결정될 때 '함수적으로 종속한다'라고 한다.


릴레이션의 속성 간에 함수적으로 종속하는 성질을 '함수 종속성' 혹은 '함수적 종속성'이라고 한다.

> 함수 종속성
> 릴레이션 R과 R에 속하는 속성의 집합 X, Y가 있을 때, X 각각의 값이 Y의 값 한 개와 대응이 될 때 `X는 Y를 함수적으로 결정한다`라고 하고 `X -> Y`로 표기한다.
> 이때 X는 결정자, Y는 종속 속성
> 함수 종속성은 보통 릴레이션 설계 때 속성의 의미로부터 정해진다.


### 함수 종속성 규칙

X, Y, Z가 릴레이션 R에 포함된 속성의 집합이라고 할 때, 함수 종속성에 관한 다음과 같은 규칙이 성립한다.
- 부분집합 : if Y ⊆ X, then X -> Y
- 증가 : if X -> Y, then XZ -> YZ
- 이행 : if X -> Y and Y -> Z, then X -> Z

위 세 가지 규칙으로부터 다음의 규칙을 얻을 수 있다.
- 결합 : if X -> Y and X -> Z, then X -> YZ
- 분해 : if X -> YZ, then X -> Y and X -> Z
- 유사이행 : if X -> Y and WY -> Z, then WX -> Z


### 함수 종속성과 기본키

릴레이션의 함수 종속성을 파악하기 위해서는 우선 기본키를 찾아야 한다.

> 릴레이션 R(K, A1, A2, A3, ..., An)에서 K가 기본키이면 K -> R이 성립한다. 즉, 기본키는 릴레이션의 모든 속성에 대한 결정자다.


### 이상현상과 결정자

이상현상은 한 개의 릴레이션에 두 개 이상의 정보가 포함되어 있을 때 나타난다.

이상현상은 기본키가 아니면서 결정자인 속성(비후보키 결정자 속성)이 있을 때 발생한다.

분해할 때 부분 릴레이션의 결정자는 원래 릴레이션에 남겨 두어야 한다. 그래야 분해된 부분 릴레이션이 원래 릴레이션과 관계를 형성할 수 있다.


### 정규화

이상현상의 원인에는 여러 가지가 있는데, 대부분 두 가지 이상의 정보가 한 릴레이션에 저장되어 있으므로 발생
-> 따라서 이상현상은 릴레이션을 분해하여 제거
-> 분해된 릴레이션에 이상현상이 남아 있다면 이상현상이 없어질 때까지 분해
-> 이상현상이 발생하는 릴레이션을 분해하여 이상현상을 없애는 과정이 정규화


### 제1정규형

릴레이션 R의 모든 속성값이 원자값을 가지면 제1정규형
-> 관계 데이터베이스에서 릴레이션의 속성값은 반드시 원자값이어야 한다


### 제2정규형

제2정규형은 릴레이션의 기본키가 복합키일 때, 복합키의 일부분이 다른 속성의 결정자인지 아닌지를 판단
- 릴레이션 R이 제1정규형이고 기본키가 아닌 속성이 기본키에 완전 함수 종속일 때 제2정규형
- 릴레이션 R이 제1정규형이고, 릴레이션 스키마 R의 모든 비주요 속성이 후보키에 완전 함수 종속일 때 제2정규형
  - 비주요 속성 : 후보키에 속하지 않는 속성


> 완전 함수 종속
> A와 B가 릴레이션 R의 속성이고 A -> B 종속성이 성립할 때, B가 A의 속성 전체에 함수 종속하고 부분집합 속성에 함수 종속하지 않을 경우 완전 함수 종속이라 한다.


> 불완전 함수 종속 or 부분 함수 종속
> A -> B 종속성에서 A의 속성 일부를 제거해도 종속성이 여전히 성립하는 경우
>
> 기본키가 아닌 속성이 기본키에 완전 함수 종속이 아닌 불완전 함수 종속되어 있으면 이상현상이 발생
> 
> 예) (A1, A2) -> B 종속성에서 A2를 제거했는데도 A1 -> B가 여전히 성립한다면 불완전 함수 종속


### 제3정규형

제3정규형은 속성들이 이행적으로 종속되어 있는지를 판단
- 릴레이션 R이 제2정규형이고 기본키가 아닌 속성이 기본키에 비이행적으로 종속할 때(직접 종속) 제3정규형
  - 이행적 종속 : A -> B, B -> C가 성립할 때 A -> C가 성립되는 함수 종속성
- (기본키 외에 후보키가 있을 경우) 릴레이션 R이 제2정규형이고, 릴레이션 스키마 R의 모든 비주요 속성(non-primary)이 후보키에 비이행적으로 종속할 때 제3정규형
  - 릴레이션의 비주요 속성이란 후보키에 속하지 않는 속성


### BCNF

릴레이션에 존재하는 함수 종속성에서 모든 결정자가 후보키이면 BCNF 정규형

> BCNF 정규형
> 릴레이션 R에서 함수 종속성(X -> Y)가 성립할 때 모든 결정자 X가 후보키이면 BCNF 정규형

BCNF 정규형은 결정자이면서 후보키가 아닌 속성이 존재하면 이상현상이 발생


### 무손실 분해

- 릴레이션을 분해할 때는, 분해된 릴레이션 간의 관계를 유지하기 위해 분해된 릴레이션에 공통 속성을 한 개 이상 두어야 한다.
- 공통 속성은 분해된 릴레이션을 다시 원래의 릴레이션으로 합성(조인)할 때 사용한다.
- 무손실 분해는 릴레이션 R을 분해하여 두 개의 릴레이션 R1과 R2를 만들었을 때, 다시 조인하면 원래의 릴레이션 R이 만들어진다.
- 무손실 분해의 조건은 분해할 때 공통된 속성이 릴레이션 R1의 키이거나 혹은 릴레이션 R2의 키여야 한다. 즉, 공통 속성이 한쪽 릴레이션의 키가 되어야 한다.


> 정규화는 릴레이션의 분해를 통해 이루어지는데, 어떤 정규형 상태인 릴레이션 R1을 분해하여 만든 R2, R3 릴레이션은 R1 다음 정규형이 아닌 더 높은 정규형이 될 수 있다.


### 반정규화

정규화의 목표는
- 중복 데이터 최소화
- 삽입/수정/삭제 시 이상 현상 방지
- 데이터 구조를 논리적으로 깨끗하게 유지


반정규화는 정규화된 구조에 의도적으로 데이터 중복이나 종속을 다시 넣어서, 성능이나 사용 편의성을 얻는 설계 기법
- 조인이 너무 많아서 쿼리가 느리고 복잡하다
- 화면 하나 띄우는데 6~7개 테이블을 조인해야 한다

반정규화의 목표로는 세 가지가 있다.
- 성능 향상
  - 조회 빈도가 높고 응답 속도가 중요한 쿼리가 조인/집계 시 느릴 때 사용
  - 이때 중복을 허용하여 조인 횟수를 줄이거나 복잡한 집계를 미리 계산해 둬서, 조회 시 단순한 select로 끝내려고 하는 것이다.
- 쿼리 단순화
  - 반정규화로 `자주 쓰는 모양`의 테이블을 만들어 두면, SQL이 훨씬 단순해져 이에 대한 유지보수가 쉬워질 수 있다.
- 비즈니스적 요구 (스냅샷/이력)
  - 주문 당시의 상품명/가격, 회원 등급/혜택 등 `그 시점의 상태 그대로`를 항상 복원해야 하는 도메인에서는
  - 마스터 테이블을 조인해서 현재값을 보는 게 아니라, 그때 값을 주문 테이블에 복사해두는 것이 더 맞는 경우가 많다고 한다.

